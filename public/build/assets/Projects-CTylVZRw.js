import{C as G,c as I,R as t,r as a,m as q}from"./CreateReactScript-BZNFBiYC.js";import{A as U,i as V,S as H}from"./Adminto-98sYPb9M.js";import{U as O,P as z,A as J,a as K}from"./AssignUsersModal-5ued5dfw.js";import{P as N,N as Q}from"./Number2Currency-BMjtDIra.js";import{T as W,R as F,M as X}from"./Table-7H_SmTdZ.js";import{a as _,S as P}from"./SetSelectValue-TcZeamg_.js";import{D,r as Z,a as u}from"./DxButton-CLrSHfzp.js";import{I as i}from"./InputFormGroup-BUOjBXeO.js";import{T as ee}from"./TextareaFormGroup-Ch_FAxDs.js";import"./TippyButton-CmK-eco3.js";import"./Dropdown-Bjfbcv4z.js";import"./DropdownItem-mg3Fv28F.js";const te=({statuses:p,can:s})=>{const o=a.useRef(),d=a.useRef(),f=a.useRef(),g=a.useRef(),b=a.useRef(),y=a.useRef(),E=a.useRef(),v=a.useRef(),x=a.useRef(),h=a.useRef(),R=a.useRef(),[j,T]=a.useState(!1),[k,S]=a.useState({}),[M,C]=a.useState({}),A=e=>{var r,l,n,c;e!=null&&e.id?T(!0):T(!1),f.current.value=(e==null?void 0:e.id)||null,P(g.current,(r=e==null?void 0:e.client)==null?void 0:r.id,(l=e==null?void 0:e.client)==null?void 0:l.name),P(b.current,(n=e==null?void 0:e.type)==null?void 0:n.id,(c=e==null?void 0:e.type)==null?void 0:c.name),y.current.value=(e==null?void 0:e.name)||null,E.current.value=(e==null?void 0:e.description)||null,v.current.value=e==null?void 0:e.cost,x.current.value=e!=null&&e.sign_at?moment(e.sign_at).format("YYYY-MM-DD"):null,h.current.value=e!=null&&e.starts_at?moment(e.starts_at).format("YYYY-MM-DD"):null,R.current.value=e!=null&&e.ends_at?moment(e.ends_at).format("YYYY-MM-DD"):null,$(d.current).modal("show")},B=async e=>{e.preventDefault();const r={id:f.current.value||void 0,client_id:g.current.value,type_id:b.current.value,name:y.current.value,description:E.current.value,cost:v.current.value??void 0,sign_at:x.current.value??void 0,starts_at:h.current.value,ends_at:R.current.value};await N.save(r)&&($(o.current).dxDataGrid("instance").refresh(),$(d.current).modal("hide"))},Y=async e=>{const{isConfirmed:r}=await H.fire({title:"Estas seguro?",text:"Esta acción no se puede deshacer",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});!r||!await N.delete(e)||$(o.current).dxDataGrid("instance").refresh()};return t.createElement(t.Fragment,null,t.createElement(W,{gridRef:o,title:"Proyectos",rest:N,toolBar:e=>{e.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"Refrescar tabla",onClick:()=>$(o.current).dxDataGrid("instance").refresh()}}),s("projects","root","all","create")&&e.unshift({widget:"dxButton",location:"after",options:{icon:"plus",hint:"Nuevo registro",onClick:()=>A()}})},filterValue:void 0,columns:[{dataField:"id",caption:"ID",dataType:"number",sortOrder:"asc",visible:!1},{dataField:"client.tradename",caption:"Nombre comercial",filterValue:q.GET.client||void 0,fixed:!0,fixedPosition:"left"},{dataField:"type.name",caption:"Tipo"},{dataField:"name",caption:"Proyecto",visible:!1},{dataField:"cost",caption:"Costo",dataType:"number",cellTemplate:(e,{data:r})=>{e.text(`S/. ${Q(r.cost)}`)}},{dataField:"remaining_amount",caption:"Pagos",dataType:"number",cellTemplate:(e,{data:r})=>{const l=(r.total_payments/r.cost*100).toFixed(2),n=Number(r.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2}),c=Number(r.cost-r.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2});e.append(D([t.createElement(t.Fragment,null,t.createElement("p",{className:"mb-0 d-flex justify-content-between"},t.createElement("b",{className:"text-success"},t.createElement("i",{className:"fa fa-arrow-circle-up"})," S/. ",n),t.createElement("b",{className:"float-end text-danger"},t.createElement("i",{className:"fa fa-arrow-circle-down"})," S/. ",c)),t.createElement("div",{className:"progress progress-bar-alt-primary progress-sm mt-0 mb-0",style:{width:"200px"}},t.createElement("div",{className:"progress-bar bg-primary progress-animated wow animated animated",role:"progressbar","aria-valuenow":r.total_payments,"aria-valuemin":"0","aria-valuemax":r.cost,style:{width:`${l}%`,visibility:"visible",animationName:"animationProgress"}})))],!1))}},{dataField:"starts_at",caption:"Fecha de inicio",dataType:"date",cellTemplate:(e,{data:r})=>{e.text(moment(r.starts_at).format("LL"))}},{dataField:"ends_at",caption:"Fecha de finalización",dataType:"date",cellTemplate:(e,{data:r})=>{e.text(moment(r.ends_at).format("LL"))}},s("projects","root","all","changestatus")?{dataField:"project_status.name",caption:"Estado del proyecto",dataType:"string",cellTemplate:(e,{data:r})=>{e.attr("style","overflow: visible"),e.append(D([{height:"0",children:t.createElement(K,{can:s,statuses:p,data:r,onChange:()=>{$(o.current).dxDataGrid("instance").refresh()}})}]))}}:null,{dataField:"users",caption:"Asignados",dataType:"string",cellTemplate:(e,{data:r})=>{const l=(r.users||"").split("|").filter(Boolean);e.append(D([t.createElement("div",{className:"avatar-group m-0"},l.map(n=>t.createElement(V,{key:`user-${n}`,content:"Cargando...",allowHTML:!0,onShow:async c=>{const m=await O.getUser(n),w=moment(m.created_at),L=moment().diff(w,"hours")>12?w.format("lll"):w.fromNow();$(c.popper).find(".tippy-content").addClass("p-0"),c.setContent(Z(t.createElement("div",{className:"card mb-0",style:{boxShadow:"0 0 10px rgba(0, 0, 0, 0.25)"}},t.createElement("div",{className:"card-body widget-user p-2"},t.createElement("div",{className:"d-flex align-items-center"},t.createElement("div",{className:"avatar-lg me-3 flex-shrink-0"},t.createElement("img",{src:`/api/profile/thumbnail/${n}`,className:"img-fluid rounded-circle",alt:"user"})),t.createElement("div",{className:"flex-grow-1 overflow-hidden"},t.createElement("h5",{className:"text-blue mt-0 mb-1"}," ",m.name," ",m.lastname),t.createElement("p",{className:"text-dark mb-1 font-13 text-truncate"},m.email),t.createElement("small",{className:"text-muted"},"Asignado: ",t.createElement("b",null,L))))))))}},t.createElement("img",{className:"avatar-group-item avatar-xs rounded-circle mb-0",src:`/api/profile/thumbnail/${n}`,style:{backdropFilter:"blur(40px)"}}))))]))}},{dataField:"status",caption:"Estado",dataType:"boolean",visible:!1,cellTemplate:(e,{data:r})=>{switch(r.status){case 1:F(e,t.createElement("span",{className:"badge bg-success rounded-pill"},"Activo"));break;case 0:F(e,t.createElement("span",{className:"badge bg-danger rounded-pill"},"Inactivo"));break;default:F(e,t.createElement("span",{className:"badge bg-dark rounded-pill"},"Eliminado"));break}}},{caption:"Acciones",cellTemplate:(e,{data:r})=>{s("projects","root","all","update")&&e.append(u({className:"btn btn-xs btn-soft-primary",title:"Editar",icon:"fa fa-pen",onClick:()=>A(r)})),s("projects","root","all","assignUsers")&&e.append(u({className:"btn btn-xs btn-soft-info",title:"Asignar usuarios",icon:"fa fa-user-plus",onClick:()=>C(r)})),s("projects","root","all","addpayment")&&e.append(u({className:"btn btn-xs btn-soft-success",title:"Ver/Agregar pagos",icon:"fas fa-money-check-alt",onClick:()=>S(r)})),s("projects","root","all","delete")&&e.append(u({className:"btn btn-xs btn-soft-danger",title:"Eliminar",icon:"fa fa-trash-alt",onClick:()=>Y(r.id)}))},allowFiltering:!1,allowExporting:!1}]}),t.createElement(X,{modalRef:d,title:j?"Editar proyecto":"Agregar proyecto",onSubmit:B},t.createElement("div",{className:"row",id:"project-crud-container"},t.createElement("input",{ref:f,type:"hidden"}),t.createElement(_,{eRef:g,label:"Cliente",col:"col-12",dropdownParent:"#project-crud-container",searchAPI:"/api/clients/paginate",searchBy:"name",required:!0}),t.createElement(_,{eRef:b,label:"Tipo del proyecto",col:"col-md-4",dropdownParent:"#project-crud-container",searchAPI:"/api/types/paginate",searchBy:"name",filter:["table_id","=",1],required:!0}),t.createElement(i,{eRef:y,label:"Nombre del proyecto",col:"col-md-8",required:!0}),t.createElement(ee,{eRef:E,label:"Descripcion del proyecto",col:"col-12"}),t.createElement(i,{eRef:v,label:"Costo",col:"col-md-6",type:"number",step:.01,required:!0}),t.createElement(i,{eRef:x,label:"Fecha firma",col:"col-md-6",type:"date"}),t.createElement(i,{eRef:h,label:"Fecha inicio",col:"col-md-6",type:"date",required:!0}),t.createElement(i,{eRef:R,label:"Fecha fin",col:"col-md-6",type:"date",required:!0}))),t.createElement(z,{can:s,dataLoaded:k,setDataLoaded:S,grid2refresh:$(o.current).dxDataGrid("instance")}),t.createElement(J,{dataLoaded:M,setDataLoaded:C,grid2refresh:$(o.current).dxDataGrid("instance")}))};G((p,s)=>{if(!s.can("projects","root","all","list"))return location.href="/";I(p).render(t.createElement(U,{...s,title:"Proyectos"},t.createElement(te,{...s})))});
