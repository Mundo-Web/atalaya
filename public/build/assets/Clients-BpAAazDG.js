import{C as U,c as W,R as e,r as n}from"./CreateReactScript-BZNFBiYC.js";import{T as H,R as l,a as o,M as J}from"./TippyButton-BXoofhyJ.js";import{C as p,a as K}from"./ClientNotesModal-CFnSgKwc.js";import{P as S}from"./ProjectsRest-Ct6mlSHF.js";import{A as Q,i as T}from"./Adminto-ePd2h6in.js";import{I as m}from"./InputFormGroup-BUOjBXeO.js";import{T as G}from"./TextareaFormGroup-Ch_FAxDs.js";import{P as X,a as Y}from"./ProjectStatusDropdown-DiIbkYQq.js";import"./SetSelectValue-TcZeamg_.js";import"./DropdownItem-mg3Fv28F.js";import"./DropdownEnd-BGPgPEIS.js";import"./Dropdown-NV6AOgpq.js";const Z=({statuses:g,can:s})=>{const i=n.useRef(),E=n.useRef(),f=n.useRef(),v=n.useRef(),R=n.useRef(),h=n.useRef(),N=n.useRef(),y=n.useRef(),x=n.useRef(),C=n.useRef(),w=n.useRef(),_=n.useRef(),[L,k]=n.useState(!1),[I,A]=n.useState({}),[M,P]=n.useState({}),[B,F]=n.useState({}),j=t=>{t!=null&&t.id?k(!0):k(!1),$('[href="#client-data"]').addClass("active"),$('[href="#contact-data"]').removeClass("active"),$("#client-data").addClass("active"),$("#contact-data").removeClass("active"),f.current.value=(t==null?void 0:t.id)||null,v.current.value=(t==null?void 0:t.ruc)||null,R.current.value=(t==null?void 0:t.name)||null,h.current.value=(t==null?void 0:t.tradename)||null,N.current.value=(t==null?void 0:t.web_url)||null,y.current.value=(t==null?void 0:t.message)||"Cliente creado desde Atalaya",x.current.value=(t==null?void 0:t.contact_name)||null,C.current.value=(t==null?void 0:t.contact_phone)||null,w.current.value=(t==null?void 0:t.contact_email)||null,_.current.value=(t==null?void 0:t.contact_address)||null,$(E.current).modal("show")},O=async t=>{t.preventDefault();const a={id:f.current.value||void 0,ruc:v.current.value,name:R.current.value,tradename:h.current.value,web_url:N.current.value,message:y.current.value??"Cliente creado desde Atalaya",contact_name:x.current.value??"",contact_phone:C.current.value??"",contact_email:w.current.value??"",contact_address:_.current.value??"",status_id:f.current.value?void 0:12};await p.save(a)&&($(i.current).dxDataGrid("instance").refresh(),$(E.current).modal("hide"))},z=async({id:t,status:a})=>{await p.status({id:t,status:a})&&$(i.current).dxDataGrid("instance").refresh()},V=async t=>{await p.delete(t)&&$(i.current).dxDataGrid("instance").refresh()},D=async(t,a)=>{await p.assign(t,a)&&$(i.current).dxDataGrid("instance").refresh()};return e.createElement(e.Fragment,null,e.createElement(H,{gridRef:i,title:"Clientes",rest:p,toolBar:t=>{t.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"REFRESCAR TABLA",onClick:()=>$(i.current).dxDataGrid("instance").refresh()}}),s("clients","root","all","create")&&t.unshift({widget:"dxButton",location:"after",options:{icon:"plus",hint:"NUEVO REGISTRO",onClick:()=>j()}})},filterValue:["status_id","=",12],columns:[s("projects","root","all","list")?{dataField:"id",caption:"ID",dataType:"number",cellTemplate:(t,{data:a,value:d,...u})=>{l(t,e.createElement(o,{className:"btn btn-xs btn-white",title:`Ver ${a.projects} proyectos`,onClick:()=>{u.component.collapseAll(-1),u.component.expandRow(u.row.data)}},e.createElement("i",{className:"fas fa-shapes"})," ",a.projects))},sortOrder:"desc"}:null,{dataField:"ruc",caption:"RUC"},{dataField:"tradename",caption:"Nombre comercial",width:250,cellTemplate:(t,{data:a})=>{l(t,e.createElement("div",{className:"d-flex align-items-center"},a.user_assigned.id&&e.createElement(T,{content:`Atendido por ${a.user_assigned.name} ${a.user_assigned.lastname}`},e.createElement("img",{className:"avatar-xs rounded-circle me-1",src:`/api/profile/thumbnail/${a.user_assigned.relative_id}`,alt:a.user_assigned.name})),e.createElement("div",null,a.tradename)))}},{dataField:"name",caption:"Razon social",visible:!1},{dataField:"contact_phone",caption:"Telefono"},{dataField:"contact_email",caption:"Correo"},{dataField:"status_id",caption:"ID estado cliente",dataType:"boolean",visible:!1},{dataField:"status",caption:"Estado",dataType:"boolean",cellTemplate:(t,{data:a})=>{switch(a.status){case 1:l(t,e.createElement("span",{className:"badge bg-success rounded-pill"},"Activo"));break;case 0:l(t,e.createElement("span",{className:"badge bg-danger rounded-pill"},"Inactivo"));break;default:l(t,e.createElement("span",{className:"badge bg-dark rounded-pill"},"Eliminado"));break}}},s("projects","root","all","list","update","changestatus","delete")?{caption:"Acciones",width:235,cellTemplate:(t,{data:a})=>{t.attr("style","display: flex; gap: 4px; overflow: visible"),s("projects","root","all","list")&&l(t,e.createElement(o,{className:"btn btn-xs btn-soft-dark",title:`Ver ${a.projects} proyectos en una nueva ventana`,onClick:()=>location.href=`/projects/?client=${a.name}`},e.createElement("i",{className:"mdi mdi-page-next"}))),s("clients","root","all","update")&&l(t,e.createElement(o,{className:"btn btn-xs btn-soft-primary",title:"Editar",onClick:()=>j(a)},e.createElement("i",{className:"fa fa-pen"}))),a.user_assigned.id?a.user_assigned.id==session.id&&l(t,e.createElement(o,{className:"btn btn-xs btn-soft-danger",title:"Dejar de atender",onClick:()=>D(a.id,!1)},e.createElement("i",{className:"fas fa-hands-wash"}))):l(t,e.createElement(o,{className:"btn btn-xs btn-soft-dark",title:"Atender lead",onClick:()=>D(a.id,!0)},e.createElement("i",{className:"fas fa-hands-helping"}))),s("leads","root","all","addnotes")&&l(t,e.createElement(o,{className:"btn btn-xs btn-soft-primary position-relative",title:"Ver/Agregar notas",onClick:()=>F(a)},e.createElement("i",{className:"fas fa-sticky-note"}),a.notes>0&&e.createElement("span",{className:"position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"},a.notes,e.createElement("span",{className:"visually-hidden"},"Notas de ",a.name)))),s("clients","root","all","changestatus")&&l(t,e.createElement(o,{className:"btn btn-xs btn-light",title:a.status===null?"Restaurar":"Cambiar estado",onClick:()=>z(a)},a.status===1?e.createElement("i",{className:"fa fa-toggle-on text-success"}):a.status===0?e.createElement("i",{className:"fa fa-toggle-off text-danger"}):e.createElement("i",{className:"fas fa-trash-restore"}))),s("clients","root","all","delete")&&l(t,e.createElement(o,{className:"btn btn-xs btn-soft-danger",title:"Eliminar",onClick:()=>V(a.id)},e.createElement("i",{className:"fa fa-trash-alt"})))},allowFiltering:!1,allowExporting:!1}:null],masterDetail:{enabled:!1,template:async(t,{data:a,component:d})=>{t.css("padding","10px"),t.css("overflow","visible");let{data:u}=await S.paginate({filter:["client_id","=",a.id],isLoadingAll:!0});const q=$('<div id="projects-grid" style="height: 320px">').appendTo(t).dxDataGrid({dataSource:u,onToolbarPreparing:r=>{r.toolbarOptions.items.unshift({widget:"dxButton",location:"after",options:{icon:"fa fa-times",hint:"CERRAR TABLA",onClick:b=>{d.collapseAll(-1)}}})},columns:[{dataField:"id",caption:"ID",dataType:"number",sortOrder:"asc"},{dataField:"type.name",caption:"Tipo"},{dataField:"name",caption:"Proyecto"},{dataField:"cost",caption:"Costo",dataType:"number",width:150,cellTemplate:(r,{data:c})=>{const b=(c.total_payments/c.cost*100).toFixed(2);l(r,e.createElement(e.Fragment,null,e.createElement("p",{className:"mb-1 d-flex justify-content-between"},e.createElement("span",null,"S/.",Number(c.total_payments).toFixed(2)),e.createElement("b",{className:"float-end"},"S/.",Number(c.cost).toFixed(2))),e.createElement("div",{className:"progress progress-bar-alt-primary progress-sm mt-0 mb-0"},e.createElement("div",{className:"progress-bar bg-primary progress-animated wow animated animated",role:"progressbar","aria-valuenow":c.total_payments,"aria-valuemin":"0","aria-valuemax":c.cost,style:{width:`${b}%`,visibility:"visible",animationName:"animationProgress"}}))))}},{dataField:"ends_at",caption:"Fecha de finalizaciÃ³n",dataType:"date",cellTemplate:(r,{data:c})=>{r.text(moment(c.ends_at).format("LL"))}},s("projects","root","all","changestatus")?{dataField:"project_status.name",caption:"Estado del proyecto",dataType:"string",cellTemplate:(r,{data:c})=>{r.attr("style","overflow: visible"),l(r,e.createElement(Y,{can:s,statuses:g,data:c,onChange:async()=>{const{data:b}=await S.paginate({filter:["client_id","=",a.id],isLoadingAll:!0});$("#projects-grid").dxDataGrid("instance").option("dataSource",b)}}))}}:null,{dataField:"status",caption:"Estado",dataType:"boolean",cellTemplate:(r,{data:c})=>{switch(c.status){case 1:l(r,e.createElement("span",{className:"badge bg-success rounded-pill"},"Activo"));break;case 0:l(r,e.createElement("span",{className:"badge bg-danger rounded-pill"},"Inactivo"));break;default:l(r,e.createElement("span",{className:"badge bg-dark rounded-pill"},"Eliminado"));break}}},{caption:"Acciones",cellTemplate:(r,{data:c})=>{r.attr("style","display: flex; gap: 4px; overflow: unset"),s("projects","root","all","addpayment")&&l(r,e.createElement(o,{className:"btn btn-xs btn-soft-success",title:"Ver/Agregar pagos",onClick:()=>A(c)},e.createElement("i",{className:"fas fa-money-check-alt"})))},allowFiltering:!1,allowExporting:!1}],allowColumnResizing:!0,columnResizingMode:"widget",columnAutoWidth:!0,showBorders:!0,columnChooser:{title:"Mostrar/Ocultar columnas",enabled:!0,mode:"select",search:{enabled:!0}}});P(q.dxDataGrid("instance"))}}}),e.createElement(J,{modalRef:E,title:L?"Editar cliente":"Agregar cliente",onSubmit:O,size:"md"},e.createElement("input",{ref:f,type:"hidden"}),e.createElement("ul",{className:"nav nav-pills navtab-bg nav-justified"},e.createElement("li",{className:"nav-item"},e.createElement(T,{content:"Datos del negocio"},e.createElement("a",{href:"#client-data","data-bs-toggle":"tab","aria-expanded":"false",className:"nav-link active"},"Negocio"))),e.createElement("li",{className:"nav-item"},e.createElement(T,{content:"Datos de contacto"},e.createElement("a",{href:"#contact-data","data-bs-toggle":"tab","aria-expanded":"true",className:"nav-link"},"Contacto")))),e.createElement("div",{className:"tab-content"},e.createElement("div",{className:"tab-pane active",id:"client-data"},e.createElement("div",{className:"row"},e.createElement(m,{eRef:v,label:"RUC",col:"col-4",required:!0}),e.createElement(m,{eRef:h,label:"Nombre comercial",col:"col-8",required:!0}),e.createElement(m,{eRef:R,label:"Razon social",col:"col-md-6",required:!0}),e.createElement(m,{eRef:N,label:"URL Web",col:"col-md-6"}),e.createElement(G,{eRef:y,label:"Mensaje",col:"col-12",required:!0}))),e.createElement("div",{className:"tab-pane show",id:"contact-data"},e.createElement("div",{className:"row"},e.createElement(m,{eRef:x,label:"Nombre de contacto",col:"col-6"}),e.createElement(m,{eRef:C,label:"Celular de contacto",type:"tel",col:"col-6"}),e.createElement(m,{eRef:w,label:"Email de contacto",col:"col-12",type:"email"}),e.createElement(G,{eRef:_,label:"Direccion de contacto",col:"col-12"}))))),e.createElement(X,{can:s,dataLoaded:I,setDataLoaded:A,grid2refresh:M}),e.createElement(K,{can:s,client:B,setClient:F,grid2refresh:i,page:"clients"}))};U((g,s)=>{if(!s.can("clients","root","all","list"))return location.href="/";W(g).render(e.createElement(Q,{...s,title:"Clientes"},e.createElement(Z,{...s})))});
