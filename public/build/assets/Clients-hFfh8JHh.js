import{A as Z,i as N}from"./Adminto-98sYPb9M.js";import{C as ee,c as te,R as e,r}from"./CreateReactScript-BZNFBiYC.js";import{C as f,a as ae}from"./ClientsRest-BzwWA7Kj.js";import{P as se,A as le,a as ne}from"./AssignUsersModal-5ued5dfw.js";import{T as re,R as c,M as ce}from"./Table-7H_SmTdZ.js";import{P as oe,N as ie}from"./Number2Currency-BMjtDIra.js";import{I as m}from"./InputFormGroup-BUOjBXeO.js";import{T as I}from"./TextareaFormGroup-Ch_FAxDs.js";import{T as i}from"./TippyButton-CmK-eco3.js";import{D as j,a as U}from"./DxButton-CLrSHfzp.js";import"./SetSelectValue-TcZeamg_.js";import"./DropdownItem-mg3Fv28F.js";import"./DropdownEnd-BGPgPEIS.js";import"./Dropdown-Bjfbcv4z.js";const me=({statuses:h,can:n})=>{const o=r.useRef(),x=r.useRef(),b=r.useRef(),y=r.useRef(),R=r.useRef(),w=r.useRef(),C=r.useRef(),T=r.useRef(),k=r.useRef(),F=r.useRef(),_=r.useRef(),A=r.useRef(),[z,S]=r.useState(!1),[q,L]=r.useState({}),[O,G]=r.useState({}),[V,H]=r.useState({}),[W,P]=r.useState({}),B=t=>{t!=null&&t.id?S(!0):S(!1),$('[href="#client-data"]').addClass("active"),$('[href="#contact-data"]').removeClass("active"),$("#client-data").addClass("active"),$("#contact-data").removeClass("active"),b.current.value=(t==null?void 0:t.id)||null,y.current.value=(t==null?void 0:t.ruc)||null,R.current.value=(t==null?void 0:t.name)||null,w.current.value=(t==null?void 0:t.tradename)||null,C.current.value=(t==null?void 0:t.web_url)||null,T.current.value=(t==null?void 0:t.message)||"Cliente creado desde Atalaya",k.current.value=(t==null?void 0:t.contact_name)||null,F.current.value=(t==null?void 0:t.contact_phone)||null,_.current.value=(t==null?void 0:t.contact_email)||null,A.current.value=(t==null?void 0:t.contact_address)||null,$(x.current).modal("show")},J=async t=>{t.preventDefault();const a={id:b.current.value||void 0,ruc:y.current.value,name:R.current.value,tradename:w.current.value,web_url:C.current.value,message:T.current.value??"Cliente creado desde Atalaya",contact_name:k.current.value??"",contact_phone:F.current.value??"",contact_email:_.current.value??"",contact_address:A.current.value??"",status_id:b.current.value?void 0:12};await f.save(a)&&($(o.current).dxDataGrid("instance").refresh(),$(x.current).modal("hide"))},K=async({id:t,status:a})=>{await f.status({id:t,status:a})&&$(o.current).dxDataGrid("instance").refresh()},Q=async t=>{await f.delete(t)&&$(o.current).dxDataGrid("instance").refresh()},M=async(t,a)=>{await f.assign(t,a)&&$(o.current).dxDataGrid("instance").refresh()};return e.createElement(e.Fragment,null,e.createElement(re,{gridRef:o,title:"Clientes",rest:f,toolBar:t=>{t.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"Refrescar tabla",onClick:()=>$(o.current).dxDataGrid("instance").refresh()}}),n("clients","root","all","create")&&t.unshift({widget:"dxButton",location:"after",options:{icon:"plus",hint:"Nuevo registro",onClick:()=>B()}})},filterValue:["status_id","=",12],columns:[n("projects","root","all","list")?{dataField:"id",caption:"ID",dataType:"number",cellTemplate:(t,{data:a,value:u,...p})=>{c(t,e.createElement(i,{className:"btn btn-xs btn-white",title:`Ver ${a.projects} proyectos`,onClick:()=>{p.component.collapseAll(-1),p.component.expandRow(p.row.data)}},e.createElement("i",{className:"fas fa-shapes"})," ",a.projects))},sortOrder:"desc"}:null,{dataField:"ruc",caption:"RUC"},{dataField:"tradename",caption:"Nombre comercial",width:250,cellTemplate:(t,{data:a})=>{c(t,e.createElement("div",{className:"d-flex align-items-center"},a.user_assigned.id&&e.createElement(N,{content:`Atendido por ${a.user_assigned.name} ${a.user_assigned.lastname}`},e.createElement("img",{className:"avatar-xs rounded-circle me-1",src:`/api/profile/thumbnail/${a.user_assigned.relative_id}`,alt:a.user_assigned.name})),e.createElement("div",null,a.tradename)))}},{dataField:"name",caption:"Razon social",visible:!1},{dataField:"contact_phone",caption:"Telefono"},{dataField:"contact_email",caption:"Correo"},{dataField:"status_id",caption:"ID estado cliente",dataType:"boolean",visible:!1},{dataField:"status",caption:"Estado",dataType:"boolean",cellTemplate:(t,{data:a})=>{switch(a.status){case 1:c(t,e.createElement("span",{className:"badge bg-success rounded-pill"},"Activo"));break;case 0:c(t,e.createElement("span",{className:"badge bg-danger rounded-pill"},"Inactivo"));break;default:c(t,e.createElement("span",{className:"badge bg-dark rounded-pill"},"Eliminado"));break}}},n("projects","root","all","list","update","changestatus","delete")?{caption:"Acciones",width:235,cellTemplate:(t,{data:a})=>{t.attr("style","display: flex; gap: 4px; overflow: visible"),n("projects","root","all","list")&&c(t,e.createElement(i,{className:"btn btn-xs btn-soft-dark",title:`Ver ${a.projects} proyectos en una nueva ventana`,onClick:()=>location.href=`/projects/?client=${a.name}`},e.createElement("i",{className:"mdi mdi-page-next"}))),n("clients","root","all","update")&&c(t,e.createElement(i,{className:"btn btn-xs btn-soft-primary",title:"Editar",onClick:()=>B(a)},e.createElement("i",{className:"fa fa-pen"}))),a.user_assigned.id?a.user_assigned.id==session.id&&c(t,e.createElement(i,{className:"btn btn-xs btn-soft-danger",title:"Dejar de atender",onClick:()=>M(a.id,!1)},e.createElement("i",{className:"fas fa-hands-wash"}))):c(t,e.createElement(i,{className:"btn btn-xs btn-soft-dark",title:"Atender lead",onClick:()=>M(a.id,!0)},e.createElement("i",{className:"fas fa-hands-helping"}))),n("leads","root","all","addnotes")&&c(t,e.createElement(i,{className:"btn btn-xs btn-soft-primary position-relative",title:"Ver/Agregar notas",onClick:()=>P(a)},e.createElement("i",{className:"fas fa-sticky-note"}),a.notes>0&&e.createElement("span",{className:"position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"},a.notes,e.createElement("span",{className:"visually-hidden"},"Notas de ",a.name)))),n("clients","root","all","changestatus")&&c(t,e.createElement(i,{className:"btn btn-xs btn-light",title:a.status===null?"Restaurar":"Cambiar estado",onClick:()=>K(a)},a.status===1?e.createElement("i",{className:"fa fa-toggle-on text-success"}):a.status===0?e.createElement("i",{className:"fa fa-toggle-off text-danger"}):e.createElement("i",{className:"fas fa-trash-restore"}))),n("clients","root","all","delete")&&c(t,e.createElement(i,{className:"btn btn-xs btn-soft-danger",title:"Eliminar",onClick:()=>Q(a.id)},e.createElement("i",{className:"fa fa-trash-alt"})))},allowFiltering:!1,allowExporting:!1}:null],masterDetail:{enabled:!1,template:async(t,{data:a,component:u})=>{t.css("padding","10px"),t.css("overflow","visible"),t.css("background-color","#323a46");let{data:p}=await oe.paginate({filter:["client_id","=",a.id],isLoadingAll:!0});const X=$('<div id="projects-grid" style="height: 320px">').appendTo(t).dxDataGrid({dataSource:p,onToolbarPreparing:l=>{l.toolbarOptions.items.unshift({widget:"dxButton",location:"after",options:{icon:"fa fa-times",hint:"CERRAR TABLA",onClick:g=>{u.collapseAll(-1)}}})},columns:[{dataField:"id",caption:"ID",dataType:"number",sortOrder:"asc",visible:!1},{dataField:"type.name",caption:"Tipo"},{dataField:"name",caption:"Proyecto",visible:!1},{dataField:"cost",caption:"Costo",dataType:"number",cellTemplate:(l,{data:s})=>{l.text(`S/. ${ie(s.cost)}`)}},{dataField:"remaining_amount",caption:"Pagos",dataType:"number",cellTemplate:(l,{data:s})=>{const g=(s.total_payments/s.cost*100).toFixed(2),d=Number(s.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2}),E=Number(s.cost-s.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2});l.append(j([e.createElement(e.Fragment,null,e.createElement("p",{className:"mb-0 d-flex justify-content-between"},e.createElement("b",{className:"text-success"},e.createElement("i",{className:"fa fa-arrow-circle-up"})," S/. ",d),e.createElement("b",{className:"float-end text-danger"},e.createElement("i",{className:"fa fa-arrow-circle-down"})," S/. ",E)),e.createElement("div",{className:"progress progress-bar-alt-primary progress-sm mt-0 mb-0",style:{width:"200px"}},e.createElement("div",{className:"progress-bar bg-primary progress-animated wow animated animated",role:"progressbar","aria-valuenow":s.total_payments,"aria-valuemin":"0","aria-valuemax":s.cost,style:{width:`${g}%`,visibility:"visible",animationName:"animationProgress"}})))],!1))}},{dataField:"starts_at",caption:"Fecha de inicio",dataType:"date",cellTemplate:(l,{data:s})=>{l.text(moment(s.starts_at).format("LL"))}},{dataField:"ends_at",caption:"Fecha de finalizaciÃ³n",dataType:"date",cellTemplate:(l,{data:s})=>{l.text(moment(s.ends_at).format("LL"))}},n("projects","root","all","changestatus")?{dataField:"project_status.name",caption:"Estado del proyecto",dataType:"string",cellTemplate:(l,{data:s})=>{l.attr("style","overflow: visible"),l.append(j([{height:"0",children:e.createElement(ne,{can:n,statuses:h,data:s,onChange:()=>{$(o.current).dxDataGrid("instance").refresh()}})}]))}}:null,{dataField:"users",caption:"Asignados",dataType:"string",cellTemplate:(l,{data:s})=>{const g=(s.users||"").split("|").filter(Boolean);l.append(j([e.createElement("div",{className:"avatar-group m-0"},g.map(d=>e.createElement(N,{key:`user-${d}`,content:"Cargando...",allowHTML:!0,onShow:async E=>{const v=await UsersByProjectsRest.getUser(d),D=moment(v.created_at),Y=moment().diff(D,"hours")>12?D.format("lll"):D.fromNow();$(E.popper).find(".tippy-content").addClass("p-0"),E.setContent(renderToString(e.createElement("div",{className:"card mb-0",style:{boxShadow:"0 0 10px rgba(0, 0, 0, 0.25)"}},e.createElement("div",{className:"card-body widget-user p-2"},e.createElement("div",{className:"d-flex align-items-center"},e.createElement("div",{className:"avatar-lg me-3 flex-shrink-0"},e.createElement("img",{src:`/api/profile/thumbnail/${d}`,className:"img-fluid rounded-circle",alt:"user"})),e.createElement("div",{className:"flex-grow-1 overflow-hidden"},e.createElement("h5",{className:"text-blue mt-0 mb-1"}," ",v.name," ",v.lastname),e.createElement("p",{className:"text-dark mb-1 font-13 text-truncate"},v.email),e.createElement("small",{className:"text-muted"},"Asignado: ",e.createElement("b",null,Y))))))))}},e.createElement("img",{className:"avatar-group-item avatar-xs rounded-circle mb-0",src:`/api/profile/thumbnail/${d}`,style:{backdropFilter:"blur(40px)"}}))))]))}},{dataField:"status",caption:"Estado",dataType:"boolean",visible:!1,cellTemplate:(l,{data:s})=>{switch(s.status){case 1:c(l,e.createElement("span",{className:"badge bg-success rounded-pill"},"Activo"));break;case 0:c(l,e.createElement("span",{className:"badge bg-danger rounded-pill"},"Inactivo"));break;default:c(l,e.createElement("span",{className:"badge bg-dark rounded-pill"},"Eliminado"));break}}},{caption:"Acciones",cellTemplate:(l,{data:s})=>{n("projects","root","all","assignUsers")&&l.append(U({className:"btn btn-xs btn-soft-info",title:"Asignar usuarios",icon:"fa fa-user-plus",onClick:()=>G(s)})),n("projects","root","all","addpayment")&&l.append(U({className:"btn btn-xs btn-soft-success",title:"Ver/Agregar pagos",icon:"fas fa-money-check-alt",onClick:()=>L(s)}))},allowFiltering:!1,allowExporting:!1}],allowColumnResizing:!0,columnResizingMode:"widget",columnAutoWidth:!0,showBorders:!0,columnChooser:{title:"Mostrar/Ocultar columnas",enabled:!0,mode:"select",search:{enabled:!0}}});H(X.dxDataGrid("instance"))}}}),e.createElement(ce,{modalRef:x,title:z?"Editar cliente":"Agregar cliente",onSubmit:J,size:"md"},e.createElement("input",{ref:b,type:"hidden"}),e.createElement("ul",{className:"nav nav-pills navtab-bg nav-justified"},e.createElement("li",{className:"nav-item"},e.createElement(N,{content:"Datos del negocio"},e.createElement("a",{href:"#client-data","data-bs-toggle":"tab","aria-expanded":"false",className:"nav-link active"},"Negocio"))),e.createElement("li",{className:"nav-item"},e.createElement(N,{content:"Datos de contacto"},e.createElement("a",{href:"#contact-data","data-bs-toggle":"tab","aria-expanded":"true",className:"nav-link"},"Contacto")))),e.createElement("div",{className:"tab-content"},e.createElement("div",{className:"tab-pane active",id:"client-data"},e.createElement("div",{className:"row"},e.createElement(m,{eRef:y,label:"RUC",col:"col-4",required:!0}),e.createElement(m,{eRef:w,label:"Nombre comercial",col:"col-8",required:!0}),e.createElement(m,{eRef:R,label:"Razon social",col:"col-md-6",required:!0}),e.createElement(m,{eRef:C,label:"URL Web",col:"col-md-6"}),e.createElement(I,{eRef:T,label:"Mensaje",col:"col-12",required:!0}))),e.createElement("div",{className:"tab-pane show",id:"contact-data"},e.createElement("div",{className:"row"},e.createElement(m,{eRef:k,label:"Nombre de contacto",col:"col-6"}),e.createElement(m,{eRef:F,label:"Celular de contacto",type:"tel",col:"col-6"}),e.createElement(m,{eRef:_,label:"Email de contacto",col:"col-12",type:"email"}),e.createElement(I,{eRef:A,label:"Direccion de contacto",col:"col-12"}))))),e.createElement(se,{can:n,dataLoaded:q,setDataLoaded:L,grid2refresh:V}),e.createElement(ae,{can:n,client:W,setClient:P,grid2refresh:o,page:"clients"}),e.createElement(le,{dataLoaded:O,setDataLoaded:G,grid2refresh:$(o.current).dxDataGrid("instance")}))};ee((h,n)=>{if(!n.can("clients","root","all","list"))return location.href="/";te(h).render(e.createElement(Z,{...n,title:"Clientes"},e.createElement(me,{...n})))});
