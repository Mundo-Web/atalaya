var z=Object.defineProperty;var Q=(o,a,n)=>a in o?z(o,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[a]=n;var k=(o,a,n)=>(Q(o,typeof a!="symbol"?a+"":a,n),n);import{m as Y,C as X,c as J,R as t,r as s}from"./CreateReactScript-BZNFBiYC.js";import{A as K,i as W,S as Z}from"./Adminto-98sYPb9M.js";import{P as ee,a as te}from"./ProjectStatusDropdown-MSZM4J3v.js";import{N as re}from"./Number2Currency-e57Tgsuk.js";import{T as ae,R as N,M}from"./Table-7H_SmTdZ.js";import{a as F,S as B}from"./SetSelectValue-TcZeamg_.js";import{P as T}from"./ProjectsRest-Ct6mlSHF.js";import{D,r as se,a as p}from"./DxBox-DWq_Qtml.js";import{I as m}from"./InputFormGroup-BUOjBXeO.js";import{T as ne}from"./TextareaFormGroup-Ch_FAxDs.js";import"./TippyButton-CmK-eco3.js";import"./Dropdown-Bjfbcv4z.js";import"./DropdownItem-mg3Fv28F.js";class I{}k(I,"getUser",async a=>{const{result:n}=await Y.Fetch(`/api/users-by-projects/${a}`);return(n==null?void 0:n.data)??null});const oe=({statuses:o,can:a})=>{const n=s.useRef(),d=s.useRef(),f=s.useRef(),g=s.useRef(),b=s.useRef(),y=s.useRef(),E=s.useRef(),v=s.useRef(),h=s.useRef(),R=s.useRef(),x=s.useRef(),S=s.useRef(),G=s.useRef(),C=s.useRef(),L=s.useRef(),[q,A]=s.useState(!1),[U,_]=s.useState({}),P=e=>{var r,c,l,i;e!=null&&e.id?A(!0):A(!1),f.current.value=(e==null?void 0:e.id)||null,B(g.current,(r=e==null?void 0:e.client)==null?void 0:r.id,(c=e==null?void 0:e.client)==null?void 0:c.name),B(b.current,(l=e==null?void 0:e.type)==null?void 0:l.id,(i=e==null?void 0:e.type)==null?void 0:i.name),y.current.value=(e==null?void 0:e.name)||null,E.current.value=(e==null?void 0:e.description)||null,v.current.value=e==null?void 0:e.cost,h.current.value=e!=null&&e.sign_at?moment(e.sign_at).format("YYYY-MM-DD"):null,R.current.value=e!=null&&e.starts_at?moment(e.starts_at).format("YYYY-MM-DD"):null,x.current.value=e!=null&&e.ends_at?moment(e.ends_at).format("YYYY-MM-DD"):null,$(d.current).modal("show")},j=async e=>{e.preventDefault();const r={id:f.current.value||void 0,client_id:g.current.value,type_id:b.current.value,name:y.current.value,description:E.current.value,cost:v.current.value??void 0,sign_at:h.current.value??void 0,starts_at:R.current.value,ends_at:x.current.value};await T.save(r)&&($(n.current).dxDataGrid("instance").refresh(),$(d.current).modal("hide"))},V=async e=>{const{isConfirmed:r}=await Z.fire({title:"Estas seguro?",text:"Esta acción no se puede deshacer",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});!r||!await T.delete(e)||$(n.current).dxDataGrid("instance").refresh()},H=async e=>{C.current.value=e,$(S.current).modal("show")};return t.createElement(t.Fragment,null,t.createElement(ae,{gridRef:n,title:"Proyectos",rest:T,toolBar:e=>{e.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"Refrescar tabla",onClick:()=>$(n.current).dxDataGrid("instance").refresh()}}),a("projects","root","all","create")&&e.unshift({widget:"dxButton",location:"after",options:{icon:"plus",hint:"Nuevo registro",onClick:()=>P()}})},filterValue:void 0,columns:[{dataField:"id",caption:"ID",dataType:"number",sortOrder:"asc",visible:!1},{dataField:"client.tradename",caption:"Nombre comercial",filterValue:Y.GET.client||void 0,fixed:!0,fixedPosition:"left"},{dataField:"type.name",caption:"Tipo"},{dataField:"name",caption:"Proyecto",visible:!1},{dataField:"cost",caption:"Costo",dataType:"number",cellTemplate:(e,{data:r})=>{e.text(`S/. ${re(r.cost)}`)}},{dataField:"remaining_amount",caption:"Pagos",dataType:"number",cellTemplate:(e,{data:r})=>{const c=(r.total_payments/r.cost*100).toFixed(2),l=Number(r.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2}),i=Number(r.cost-r.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2});e.append(D([t.createElement(t.Fragment,null,t.createElement("p",{className:"mb-0 d-flex justify-content-between"},t.createElement("b",{className:"text-success"},t.createElement("i",{className:"fa fa-arrow-circle-up"})," S/. ",l),t.createElement("b",{className:"float-end text-danger"},t.createElement("i",{className:"fa fa-arrow-circle-down"})," S/. ",i)),t.createElement("div",{className:"progress progress-bar-alt-primary progress-sm mt-0 mb-0",style:{width:"200px"}},t.createElement("div",{className:"progress-bar bg-primary progress-animated wow animated animated",role:"progressbar","aria-valuenow":r.total_payments,"aria-valuemin":"0","aria-valuemax":r.cost,style:{width:`${c}%`,visibility:"visible",animationName:"animationProgress"}})))],!1))}},{dataField:"starts_at",caption:"Fecha de inicio",dataType:"date",cellTemplate:(e,{data:r})=>{e.text(moment(r.starts_at).format("LL"))}},{dataField:"ends_at",caption:"Fecha de finalización",dataType:"date",cellTemplate:(e,{data:r})=>{e.text(moment(r.ends_at).format("LL"))}},a("projects","root","all","changestatus")?{dataField:"project_status.name",caption:"Estado del proyecto",dataType:"string",cellTemplate:(e,{data:r})=>{e.attr("style","overflow: visible"),e.append(D([{height:"0",children:t.createElement(te,{can:a,statuses:o,data:r,onChange:()=>{$(n.current).dxDataGrid("instance").refresh()}})}]))}}:null,{dataField:"users",caption:"Asignados",dataType:"string",cellTemplate:(e,{data:r})=>{const c=(r.users||"").split("|").filter(Boolean);e.append(D([t.createElement("div",{className:"avatar-group m-0"},c.map(l=>t.createElement(W,{key:`user-${l}`,content:"Cargando...",allowHTML:!0,onShow:async i=>{const u=await I.getUser(l),w=moment(u.created_at).add(5,"hours"),O=moment().diff(w,"hours")>12?w.format("lll"):w.fromNow();$(i.popper).find(".tippy-content").addClass("p-0"),i.setContent(se(t.createElement("div",{className:"card mb-0",style:{boxShadow:"0 0 10px rgba(0, 0, 0, 0.25)"}},t.createElement("div",{className:"card-body widget-user p-2"},t.createElement("div",{className:"d-flex align-items-center"},t.createElement("div",{className:"avatar-lg me-3 flex-shrink-0"},t.createElement("img",{src:`/api/profile/thumbnail/${l}`,className:"img-fluid rounded-circle",alt:"user"})),t.createElement("div",{className:"flex-grow-1 overflow-hidden"},t.createElement("h5",{className:"text-blue mt-0 mb-1"}," ",u.name," ",u.lastname),t.createElement("p",{className:"text-dark mb-1 font-13 text-truncate"},u.email),t.createElement("small",{className:"text-muted"},"Asignado: ",t.createElement("b",null,O))))))))}},t.createElement("img",{className:"avatar-group-item avatar-xs rounded-circle mb-0",src:`/api/profile/thumbnail/${l}`,style:{backdropFilter:"blur(40px)"}}))))]))}},{dataField:"status",caption:"Estado",dataType:"boolean",visible:!1,cellTemplate:(e,{data:r})=>{switch(r.status){case 1:N(e,t.createElement("span",{className:"badge bg-success rounded-pill"},"Activo"));break;case 0:N(e,t.createElement("span",{className:"badge bg-danger rounded-pill"},"Inactivo"));break;default:N(e,t.createElement("span",{className:"badge bg-dark rounded-pill"},"Eliminado"));break}}},{caption:"Acciones",cellTemplate:(e,{data:r})=>{a("projects","root","all","update")&&e.append(p({className:"btn btn-xs btn-soft-primary",title:"Editar",icon:"fa fa-pen",onClick:()=>P(r)})),a("projects","root","all","assignUsers")&&e.append(p({className:"btn btn-xs btn-soft-info",title:"Asignar usuarios",icon:"fa fa-user-plus",onClick:()=>H()})),a("projects","root","all","addpayment")&&e.append(p({className:"btn btn-xs btn-soft-success",title:"Ver/Agregar pagos",icon:"fas fa-money-check-alt",onClick:()=>_(r)})),a("projects","root","all","delete")&&e.append(p({className:"btn btn-xs btn-soft-danger",title:"Eliminar",icon:"fa fa-trash-alt",onClick:()=>V(r.id)}))},allowFiltering:!1,allowExporting:!1}]}),t.createElement(M,{modalRef:d,title:q?"Editar proyecto":"Agregar proyecto",onSubmit:j},t.createElement("div",{className:"row",id:"project-crud-container"},t.createElement("input",{ref:f,type:"hidden"}),t.createElement(F,{eRef:g,label:"Cliente",col:"col-12",dropdownParent:"#project-crud-container",searchAPI:"/api/clients/paginate",searchBy:"name",required:!0}),t.createElement(F,{eRef:b,label:"Tipo del proyecto",col:"col-md-4",dropdownParent:"#project-crud-container",searchAPI:"/api/types/paginate",searchBy:"name",filter:["table_id","=",1],required:!0}),t.createElement(m,{eRef:y,label:"Nombre del proyecto",col:"col-md-8",required:!0}),t.createElement(ne,{eRef:E,label:"Descripcion del proyecto",col:"col-12"}),t.createElement(m,{eRef:v,label:"Costo",col:"col-md-6",type:"number",step:.01,required:!0}),t.createElement(m,{eRef:h,label:"Fecha firma",col:"col-md-6",type:"date"}),t.createElement(m,{eRef:R,label:"Fecha inicio",col:"col-md-6",type:"date",required:!0}),t.createElement(m,{eRef:x,label:"Fecha fin",col:"col-md-6",type:"date",required:!0}))),t.createElement(ee,{can:a,dataLoaded:U,setDataLoaded:_,grid2refresh:$(n.current).dxDataGrid("instance")}),t.createElement(M,{modalRef:S,title:"Asignar usuarios al proyecto",onSubmit:j},t.createElement("div",{id:"assign-users-container"},t.createElement("p",null,"Que usuarios deseas asignar al proyecto ",t.createElement("b",{ref:G},"X")),t.createElement("input",{ref:C,type:"hidden"}),t.createElement(F,{eRef:L,label:"Usuarios a asignar",col:"col-12",dropdownParent:"#assign-users-container",searchAPI:"/api/users/paginate",searchBy:"name"}))))};X((o,a)=>{if(!a.can("projects","root","all","list"))return location.href="/";J(o).render(t.createElement(K,{...a,title:"Proyectos"},t.createElement(oe,{...a})))});
