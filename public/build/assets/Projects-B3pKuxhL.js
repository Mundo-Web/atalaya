import{C as L,c as U,R as t,r as a,m as V}from"./CreateReactScript-BZNFBiYC.js";import{A as H,i as O,S as z}from"./Adminto-98sYPb9M.js";import{U as J,a as K,A as Q,P as W}from"./AssignUsersModal-D8MeNS4D.js";import{P as F,N as X}from"./Number2Currency-BMjtDIra.js";import{T as Z,R as T,M as ee}from"./Table-7H_SmTdZ.js";import{a as _,S as j}from"./SetSelectValue-TcZeamg_.js";import{D as p}from"./DxButton-CsjWvhyj.js";import{I as u}from"./InputFormGroup-BUOjBXeO.js";import{T as te}from"./TextareaFormGroup-Ch_FAxDs.js";import{D as d,r as re}from"./DxBox-Dl1dY3VA.js";import"./TippyButton-CmK-eco3.js";import"./Dropdown-Bjfbcv4z.js";import"./DropdownItem-mg3Fv28F.js";const ae=({statuses:f,can:s})=>{const i=a.useRef(),g=a.useRef(),b=a.useRef(),E=a.useRef(),y=a.useRef(),v=a.useRef(),x=a.useRef(),h=a.useRef(),w=a.useRef(),N=a.useRef(),R=a.useRef(),[P,S]=a.useState(!1),[k,A]=a.useState({}),[B,C]=a.useState({}),M=e=>{var r,n,l,o;e!=null&&e.id?S(!0):S(!1),b.current.value=(e==null?void 0:e.id)||null,j(E.current,(r=e==null?void 0:e.client)==null?void 0:r.id,(n=e==null?void 0:e.client)==null?void 0:n.name),j(y.current,(l=e==null?void 0:e.type)==null?void 0:l.id,(o=e==null?void 0:e.type)==null?void 0:o.name),v.current.value=(e==null?void 0:e.name)||null,x.current.value=(e==null?void 0:e.description)||null,h.current.value=e==null?void 0:e.cost,w.current.value=e!=null&&e.sign_at?moment(e.sign_at).format("YYYY-MM-DD"):null,N.current.value=e!=null&&e.starts_at?moment(e.starts_at).format("YYYY-MM-DD"):null,R.current.value=e!=null&&e.ends_at?moment(e.ends_at).format("YYYY-MM-DD"):null,$(g.current).modal("show")},Y=async e=>{e.preventDefault();const r={id:b.current.value||void 0,client_id:E.current.value,type_id:y.current.value,name:v.current.value,description:x.current.value,cost:h.current.value??void 0,sign_at:w.current.value??void 0,starts_at:N.current.value,ends_at:R.current.value};await F.save(r)&&($(i.current).dxDataGrid("instance").refresh(),$(g.current).modal("hide"))},G=async e=>{const{isConfirmed:r}=await z.fire({title:"Estas seguro?",text:"Esta acción no se puede deshacer",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});!r||!await F.delete(e)||$(i.current).dxDataGrid("instance").refresh()};return t.createElement(t.Fragment,null,t.createElement(Z,{gridRef:i,title:"Proyectos",rest:F,toolBar:e=>{e.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"Refrescar tabla",onClick:()=>$(i.current).dxDataGrid("instance").refresh()}}),s("projects","root","all","create")&&e.unshift({widget:"dxButton",location:"after",options:{icon:"plus",hint:"Nuevo registro",onClick:()=>M()}})},filterValue:void 0,columns:[{dataField:"id",caption:"ID",dataType:"number",sortOrder:"asc",visible:!1},{dataField:"client.tradename",caption:"Nombre comercial",filterValue:V.GET.client||void 0,fixed:!0,fixedPosition:"left"},{dataField:"type.name",caption:"Tipo"},{dataField:"name",caption:"Proyecto",visible:!1},{dataField:"users",caption:"Asignados",dataType:"string",cellTemplate:(e,{data:r})=>{const n=(r.users||"").split("|").filter(Boolean);e.append(d([t.createElement("div",{className:"avatar-group m-0"},n.map(l=>t.createElement(O,{key:`user-${l}`,content:"Cargando...",allowHTML:!0,onShow:async o=>{const c=await J.getUser(l),m=moment(c.created_at),q=moment().diff(m,"hours")>12?m.format("lll"):m.fromNow();$(o.popper).find(".tippy-content").addClass("p-0"),o.setContent(re(t.createElement("div",{className:"card mb-0",style:{boxShadow:"0 0 10px rgba(0, 0, 0, 0.25)"}},t.createElement("div",{className:"card-body widget-user p-2"},t.createElement("div",{className:"d-flex align-items-center"},t.createElement("div",{className:"avatar-lg me-3 flex-shrink-0"},t.createElement("img",{src:`/api/profile/thumbnail/${l}`,className:"img-fluid rounded-circle",alt:"user"})),t.createElement("div",{className:"flex-grow-1 overflow-hidden"},t.createElement("h5",{className:"text-blue mt-0 mb-1"}," ",c.name," ",c.lastname),t.createElement("p",{className:"text-dark mb-1 font-13 text-truncate"},c.email),t.createElement("small",{className:"text-muted"},"Asignado: ",t.createElement("b",null,q))))))))}},t.createElement("img",{className:"avatar-group-item avatar-xs rounded-circle mb-0",src:`/api/profile/thumbnail/${l}`,style:{backdropFilter:"blur(40px)"}}))))]))}},{dataField:"cost",caption:"Costo",dataType:"number",cellTemplate:(e,{data:r})=>{e.text(`S/. ${X(r.cost)}`)}},{dataField:"remaining_amount",caption:"Pagos",dataType:"number",cellTemplate:(e,{data:r})=>{const n=(r.total_payments/r.cost*100).toFixed(2),l=Number(r.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2}),o=Number(r.cost-r.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2});e.append(d([t.createElement(t.Fragment,null,t.createElement("p",{className:"mb-0 d-flex justify-content-between"},t.createElement("b",{className:"text-success"},t.createElement("i",{className:"fa fa-arrow-circle-up"})," S/. ",l),t.createElement("b",{className:"float-end text-danger"},t.createElement("i",{className:"fa fa-arrow-circle-down"})," S/. ",o)),t.createElement("div",{className:"progress progress-bar-alt-primary progress-sm mt-0 mb-0",style:{width:"200px"}},t.createElement("div",{className:"progress-bar bg-primary progress-animated wow animated animated",role:"progressbar","aria-valuenow":r.total_payments,"aria-valuemin":"0","aria-valuemax":r.cost,style:{width:`${n}%`,visibility:"visible",animationName:"animationProgress"}})))],!1))}},{dataField:"starts_at",caption:"Fecha de inicio",dataType:"date",cellTemplate:(e,{data:r})=>{const n=moment(r.starts_at),l=moment(r.ends_at),o=moment();let c=t.createElement(t.Fragment,null);if(o.isBefore(n))c=t.createElement("i",{className:"text-primary"},"El proyecto aún no comienza");else if(o.isAfter(l))c=t.createElement("i",{className:"text-danger"},"El proyecto ya terminó");else{const m=l.diff(n),D=o.diff(n)/m*100;c=t.createElement("div",{style:{width:"200px"}},t.createElement("p",{className:"mb-0 d-flex justify-content-between"},t.createElement("span",null,moment(r.starts_at).format("DD MMMM")),t.createElement("span",{className:"float-end text-danger"},moment(r.ends_at).format("DD MMMM"))),t.createElement("div",{className:"progress progress-bar-alt-success mb-0 mt-0"},t.createElement("div",{className:"progress-bar  progress-bar-primary progress-bar-animated",role:"progressbar","aria-valuenow":"75","aria-valuemin":"0","aria-valuemax":"100",style:{width:`${D}%`}},D.toFixed(2),"%")))}e.append(d([{width:"200px",children:c}]))}},s("projects","root","all","changestatus")?{dataField:"project_status.name",caption:"Estado del proyecto",dataType:"string",cellTemplate:(e,{data:r})=>{e.attr("style","overflow: visible"),e.append(d([{height:"0",children:t.createElement(W,{can:s,statuses:f,data:r,onChange:()=>{$(i.current).dxDataGrid("instance").refresh()}})}]))}}:null,{dataField:"status",caption:"Estado",dataType:"boolean",visible:!1,cellTemplate:(e,{data:r})=>{switch(r.status){case 1:T(e,t.createElement("span",{className:"badge bg-success rounded-pill"},"Activo"));break;case 0:T(e,t.createElement("span",{className:"badge bg-danger rounded-pill"},"Inactivo"));break;default:T(e,t.createElement("span",{className:"badge bg-dark rounded-pill"},"Eliminado"));break}}},{caption:"Acciones",cellTemplate:(e,{data:r})=>{s("projects","root","all","update")&&e.append(p({className:"btn btn-xs btn-soft-primary",title:"Editar",icon:"fa fa-pen",onClick:()=>M(r)})),s("projects","root","all","assignUsers")&&e.append(p({className:"btn btn-xs btn-soft-info",title:"Asignar usuarios",icon:"fa fa-user-plus",onClick:()=>C(r)})),s("projects","root","all","addpayment")&&e.append(p({className:"btn btn-xs btn-soft-success",title:"Ver/Agregar pagos",icon:"fas fa-money-check-alt",onClick:()=>A(r)})),s("projects","root","all","delete")&&e.append(p({className:"btn btn-xs btn-soft-danger",title:"Eliminar",icon:"fa fa-trash-alt",onClick:()=>G(r.id)}))},allowFiltering:!1,allowExporting:!1}]}),t.createElement(ee,{modalRef:g,title:P?"Editar proyecto":"Agregar proyecto",onSubmit:Y},t.createElement("div",{className:"row",id:"project-crud-container"},t.createElement("input",{ref:b,type:"hidden"}),t.createElement(_,{eRef:E,label:"Cliente",col:"col-12",dropdownParent:"#project-crud-container",searchAPI:"/api/clients/paginate",searchBy:"name",required:!0}),t.createElement(_,{eRef:y,label:"Tipo del proyecto",col:"col-md-4",dropdownParent:"#project-crud-container",searchAPI:"/api/types/paginate",searchBy:"name",filter:["table_id","=",1],required:!0}),t.createElement(u,{eRef:v,label:"Nombre del proyecto",col:"col-md-8",required:!0}),t.createElement(te,{eRef:x,label:"Descripcion del proyecto",col:"col-12"}),t.createElement(u,{eRef:h,label:"Costo",col:"col-md-6",type:"number",step:.01,required:!0}),t.createElement(u,{eRef:w,label:"Fecha firma",col:"col-md-6",type:"date"}),t.createElement(u,{eRef:N,label:"Fecha inicio",col:"col-md-6",type:"date",required:!0}),t.createElement(u,{eRef:R,label:"Fecha fin",col:"col-md-6",type:"date",required:!0}))),t.createElement(K,{can:s,dataLoaded:k,setDataLoaded:A,grid2refresh:$(i.current).dxDataGrid("instance")}),t.createElement(Q,{dataLoaded:B,setDataLoaded:C,grid2refresh:$(i.current).dxDataGrid("instance")}))};L((f,s)=>{if(!s.can("projects","root","all","list"))return location.href="/";U(f).render(t.createElement(H,{...s,title:"Proyectos"},t.createElement(ae,{...s})))});
