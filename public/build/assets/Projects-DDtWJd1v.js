var H=Object.defineProperty;var V=(a,s,n)=>s in a?H(a,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):a[s]=n;var R=(a,s,n)=>(V(a,typeof s!="symbol"?s+"":s,n),n);import{m as b,r as l,R as t,C as z,c as J}from"./CreateReactScript-BZNFBiYC.js";import{A as Q,i as K,S as W}from"./Adminto-98sYPb9M.js";import{P as X,a as Z}from"./ProjectStatusDropdown-MSZM4J3v.js";import{N as L}from"./Number2Currency-e57Tgsuk.js";import{M as B,T as ee,R as j}from"./Table-7H_SmTdZ.js";import{S as F,a as C}from"./SetSelectValue-TcZeamg_.js";import{P as S}from"./ProjectsRest-Ct6mlSHF.js";import{D as P,r as te,a as N}from"./DxBox-DWq_Qtml.js";import{I as h}from"./InputFormGroup-BUOjBXeO.js";import{T as re}from"./TextareaFormGroup-Ch_FAxDs.js";import"./TippyButton-CmK-eco3.js";import"./Dropdown-Bjfbcv4z.js";import"./DropdownItem-mg3Fv28F.js";class y{}R(y,"getUser",async s=>{const{result:n}=await b.Fetch(`/api/users-by-projects/${s}`);return(n==null?void 0:n.data)??null}),R(y,"byProject",async s=>{const{result:n}=await b.Fetch(`/api/users-by-projects/project/${s}`);return(n==null?void 0:n.data)??[]}),R(y,"massiveByProject",async s=>{try{const{status:n,result:o}=await b.Fetch("/api/users-by-projects/project",{method:"PATCH",body:JSON.stringify(s)});if(!n)throw new Error((o==null?void 0:o.message)||"Ocurrio un error inesperado");return b.Notify.add({icon:"/assets/img/logo-login.svg",title:"Correcto",body:o.message,type:"success"}),!0}catch(n){return b.Notify.add({icon:"/assets/img/logo-login.svg",title:"Error",body:n.message,type:"danger"}),!1}});const se=({dataLoaded:a,setDataLoaded:s,grid2refresh:n})=>{var d;const o=l.useRef(),i=l.useRef(),m=l.useRef();l.useEffect(()=>{a.id&&E(),$(o.current).on("hidden.bs.modal",()=>{i.current.value=null,F(m.current,null,null),s({})})},[a]);const E=async()=>{const p=await y.byProject(a==null?void 0:a.id);i.current.value=(a==null?void 0:a.id)||null,F(m.current,p,"id","fullname"),$(o.current).modal("show")},v=async p=>{p.preventDefault();const g={project_id:i.current.value,users:$(m.current).val()};console.log(g),await y.massiveByProject(g)&&($(o.current).modal("hide"),n.refresh())};return t.createElement(B,{modalRef:o,title:"Asignar usuarios al proyecto",onSubmit:v},t.createElement("div",{id:"assign-users-container"},t.createElement("p",null,"Que usuarios deseas asignar al proyecto ",t.createElement("b",null,a==null?void 0:a.name)," de ",t.createElement("b",null,(d=a==null?void 0:a.client)==null?void 0:d.name)),t.createElement("input",{ref:i,type:"hidden"}),t.createElement(C,{eRef:m,label:"Usuarios a asignar",col:"col-12",dropdownParent:"#assign-users-container",searchAPI:"/api/users/paginate",searchBy:"fullname",multiple:!0})))},ne=({statuses:a,can:s})=>{const n=l.useRef(),o=l.useRef(),i=l.useRef(),m=l.useRef(),E=l.useRef(),v=l.useRef(),d=l.useRef(),p=l.useRef(),g=l.useRef(),x=l.useRef(),D=l.useRef(),[Y,A]=l.useState(!1),[G,_]=l.useState({}),[I,k]=l.useState({}),M=e=>{var r,u,c,f;e!=null&&e.id?A(!0):A(!1),i.current.value=(e==null?void 0:e.id)||null,F(m.current,(r=e==null?void 0:e.client)==null?void 0:r.id,(u=e==null?void 0:e.client)==null?void 0:u.name),F(E.current,(c=e==null?void 0:e.type)==null?void 0:c.id,(f=e==null?void 0:e.type)==null?void 0:f.name),v.current.value=(e==null?void 0:e.name)||null,d.current.value=(e==null?void 0:e.description)||null,p.current.value=e==null?void 0:e.cost,g.current.value=e!=null&&e.sign_at?moment(e.sign_at).format("YYYY-MM-DD"):null,x.current.value=e!=null&&e.starts_at?moment(e.starts_at).format("YYYY-MM-DD"):null,D.current.value=e!=null&&e.ends_at?moment(e.ends_at).format("YYYY-MM-DD"):null,$(o.current).modal("show")},q=async e=>{e.preventDefault();const r={id:i.current.value||void 0,client_id:m.current.value,type_id:E.current.value,name:v.current.value,description:d.current.value,cost:p.current.value??void 0,sign_at:g.current.value??void 0,starts_at:x.current.value,ends_at:D.current.value};await S.save(r)&&($(n.current).dxDataGrid("instance").refresh(),$(o.current).modal("hide"))},O=async e=>{const{isConfirmed:r}=await W.fire({title:"Estas seguro?",text:"Esta acción no se puede deshacer",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});!r||!await S.delete(e)||$(n.current).dxDataGrid("instance").refresh()};return t.createElement(t.Fragment,null,t.createElement(ee,{gridRef:n,title:"Proyectos",rest:S,toolBar:e=>{e.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"Refrescar tabla",onClick:()=>$(n.current).dxDataGrid("instance").refresh()}}),s("projects","root","all","create")&&e.unshift({widget:"dxButton",location:"after",options:{icon:"plus",hint:"Nuevo registro",onClick:()=>M()}})},filterValue:void 0,columns:[{dataField:"id",caption:"ID",dataType:"number",sortOrder:"asc",visible:!1},{dataField:"client.tradename",caption:"Nombre comercial",filterValue:b.GET.client||void 0,fixed:!0,fixedPosition:"left"},{dataField:"type.name",caption:"Tipo"},{dataField:"name",caption:"Proyecto",visible:!1},{dataField:"cost",caption:"Costo",dataType:"number",cellTemplate:(e,{data:r})=>{e.text(`S/. ${L(r.cost)}`)}},{dataField:"remaining_amount",caption:"Pagos",dataType:"number",cellTemplate:(e,{data:r})=>{const u=(r.total_payments/r.cost*100).toFixed(2),c=Number(r.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2}),f=Number(r.cost-r.total_payments).toLocaleString("en-US",{maximumFractionDigits:2,minimumFractionDigits:2});e.append(P([t.createElement(t.Fragment,null,t.createElement("p",{className:"mb-0 d-flex justify-content-between"},t.createElement("b",{className:"text-success"},t.createElement("i",{className:"fa fa-arrow-circle-up"})," S/. ",c),t.createElement("b",{className:"float-end text-danger"},t.createElement("i",{className:"fa fa-arrow-circle-down"})," S/. ",f)),t.createElement("div",{className:"progress progress-bar-alt-primary progress-sm mt-0 mb-0",style:{width:"200px"}},t.createElement("div",{className:"progress-bar bg-primary progress-animated wow animated animated",role:"progressbar","aria-valuenow":r.total_payments,"aria-valuemin":"0","aria-valuemax":r.cost,style:{width:`${u}%`,visibility:"visible",animationName:"animationProgress"}})))],!1))}},{dataField:"starts_at",caption:"Fecha de inicio",dataType:"date",cellTemplate:(e,{data:r})=>{e.text(moment(r.starts_at).format("LL"))}},{dataField:"ends_at",caption:"Fecha de finalización",dataType:"date",cellTemplate:(e,{data:r})=>{e.text(moment(r.ends_at).format("LL"))}},s("projects","root","all","changestatus")?{dataField:"project_status.name",caption:"Estado del proyecto",dataType:"string",cellTemplate:(e,{data:r})=>{e.attr("style","overflow: visible"),e.append(P([{height:"0",children:t.createElement(Z,{can:s,statuses:a,data:r,onChange:()=>{$(n.current).dxDataGrid("instance").refresh()}})}]))}}:null,{dataField:"users",caption:"Asignados",dataType:"string",cellTemplate:(e,{data:r})=>{const u=(r.users||"").split("|").filter(Boolean);e.append(P([t.createElement("div",{className:"avatar-group m-0"},u.map(c=>t.createElement(K,{key:`user-${c}`,content:"Cargando...",allowHTML:!0,onShow:async f=>{const w=await y.getUser(c),T=moment(w.created_at),U=moment().diff(T,"hours")>12?T.format("lll"):T.fromNow();$(f.popper).find(".tippy-content").addClass("p-0"),f.setContent(te(t.createElement("div",{className:"card mb-0",style:{boxShadow:"0 0 10px rgba(0, 0, 0, 0.25)"}},t.createElement("div",{className:"card-body widget-user p-2"},t.createElement("div",{className:"d-flex align-items-center"},t.createElement("div",{className:"avatar-lg me-3 flex-shrink-0"},t.createElement("img",{src:`/api/profile/thumbnail/${c}`,className:"img-fluid rounded-circle",alt:"user"})),t.createElement("div",{className:"flex-grow-1 overflow-hidden"},t.createElement("h5",{className:"text-blue mt-0 mb-1"}," ",w.name," ",w.lastname),t.createElement("p",{className:"text-dark mb-1 font-13 text-truncate"},w.email),t.createElement("small",{className:"text-muted"},"Asignado: ",t.createElement("b",null,U))))))))}},t.createElement("img",{className:"avatar-group-item avatar-xs rounded-circle mb-0",src:`/api/profile/thumbnail/${c}`,style:{backdropFilter:"blur(40px)"}}))))]))}},{dataField:"status",caption:"Estado",dataType:"boolean",visible:!1,cellTemplate:(e,{data:r})=>{switch(r.status){case 1:j(e,t.createElement("span",{className:"badge bg-success rounded-pill"},"Activo"));break;case 0:j(e,t.createElement("span",{className:"badge bg-danger rounded-pill"},"Inactivo"));break;default:j(e,t.createElement("span",{className:"badge bg-dark rounded-pill"},"Eliminado"));break}}},{caption:"Acciones",cellTemplate:(e,{data:r})=>{s("projects","root","all","update")&&e.append(N({className:"btn btn-xs btn-soft-primary",title:"Editar",icon:"fa fa-pen",onClick:()=>M(r)})),s("projects","root","all","assignUsers")&&e.append(N({className:"btn btn-xs btn-soft-info",title:"Asignar usuarios",icon:"fa fa-user-plus",onClick:()=>k(r)})),s("projects","root","all","addpayment")&&e.append(N({className:"btn btn-xs btn-soft-success",title:"Ver/Agregar pagos",icon:"fas fa-money-check-alt",onClick:()=>_(r)})),s("projects","root","all","delete")&&e.append(N({className:"btn btn-xs btn-soft-danger",title:"Eliminar",icon:"fa fa-trash-alt",onClick:()=>O(r.id)}))},allowFiltering:!1,allowExporting:!1}]}),t.createElement(B,{modalRef:o,title:Y?"Editar proyecto":"Agregar proyecto",onSubmit:q},t.createElement("div",{className:"row",id:"project-crud-container"},t.createElement("input",{ref:i,type:"hidden"}),t.createElement(C,{eRef:m,label:"Cliente",col:"col-12",dropdownParent:"#project-crud-container",searchAPI:"/api/clients/paginate",searchBy:"name",required:!0}),t.createElement(C,{eRef:E,label:"Tipo del proyecto",col:"col-md-4",dropdownParent:"#project-crud-container",searchAPI:"/api/types/paginate",searchBy:"name",filter:["table_id","=",1],required:!0}),t.createElement(h,{eRef:v,label:"Nombre del proyecto",col:"col-md-8",required:!0}),t.createElement(re,{eRef:d,label:"Descripcion del proyecto",col:"col-12"}),t.createElement(h,{eRef:p,label:"Costo",col:"col-md-6",type:"number",step:.01,required:!0}),t.createElement(h,{eRef:g,label:"Fecha firma",col:"col-md-6",type:"date"}),t.createElement(h,{eRef:x,label:"Fecha inicio",col:"col-md-6",type:"date",required:!0}),t.createElement(h,{eRef:D,label:"Fecha fin",col:"col-md-6",type:"date",required:!0}))),t.createElement(X,{can:s,dataLoaded:G,setDataLoaded:_,grid2refresh:$(n.current).dxDataGrid("instance")}),t.createElement(se,{dataLoaded:I,setDataLoaded:k,grid2refresh:$(n.current).dxDataGrid("instance")}))};z((a,s)=>{if(!s.can("projects","root","all","list"))return location.href="/";J(a).render(t.createElement(Q,{...s,title:"Proyectos"},t.createElement(ne,{...s})))});
