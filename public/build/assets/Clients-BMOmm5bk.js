import{C as U,c as W,R as t,r as s}from"./CreateReactScript-ClVaIZLH.js";import{T as H,R as a,a as c,M as J}from"./TippyButton-CHWO023D.js";import{C as p,a as K}from"./ClientNotesModal-BKWJcSlc.js";import{P as S}from"./ProjectsRest-CvImo7jp.js";import{A as Q}from"./Adminto-bIdH5RnD.js";import{I as m}from"./InputFormGroup-Bbi-6ZmO.js";import{T as A}from"./TextareaFormGroup-D05xY0Ci.js";import{P as X,a as Y}from"./ProjectStatusDropdown-Bu8_vaX7.js";import"./Dropdown-3pKYyIV2.js";import"./SetSelectValue-CwDYwahQ.js";import"./DropdownItem-CGQ01ebz.js";import"./DropdownEnd-TZDw8Qnf.js";const Z=({statuses:b,can:n})=>{const i=s.useRef(),g=s.useRef(),E=s.useRef(),R=s.useRef(),v=s.useRef(),h=s.useRef(),y=s.useRef(),N=s.useRef(),x=s.useRef(),w=s.useRef(),C=s.useRef(),_=s.useRef(),T=s.useRef(),[L,F]=s.useState(!1),[G,k]=s.useState({}),[I,M]=s.useState({}),[P,j]=s.useState({}),B=e=>{e!=null&&e.id?F(!0):F(!1),E.current.value=(e==null?void 0:e.id)||null,R.current.value=(e==null?void 0:e.ruc)||null,v.current.value=(e==null?void 0:e.name)||null,h.current.value=(e==null?void 0:e.tradename)||null,y.current.value=(e==null?void 0:e.weburl)||null,N.current.value=(e==null?void 0:e.message)||"Cliente creado desde Atalaya",x.current.value=(e==null?void 0:e.description)||null,w.current.value=(e==null?void 0:e.contact_name)||null,C.current.value=(e==null?void 0:e.contact_phone)||null,_.current.value=(e==null?void 0:e.contact_email)||null,T.current.value=(e==null?void 0:e.contact_address)||null,$(g.current).modal("show")},z=async e=>{e.preventDefault();const l={id:E.current.value||void 0,ruc:R.current.value,name:v.current.value,tradename:h.current.value,web_url:y.current.value,message:N.current.value??"Cliente creado desde Atalaya",description:x.current.value??"",contact_name:w.current.value??"",contact_phone:C.current.value??"",contact_email:_.current.value??"",contact_address:T.current.value??""};await p.save(l)&&($(i.current).dxDataGrid("instance").refresh(),$(g.current).modal("hide"))},q=async({id:e,status:l})=>{await p.status({id:e,status:l})&&$(i.current).dxDataGrid("instance").refresh()},O=async e=>{await p.delete(e)&&$(i.current).dxDataGrid("instance").refresh()},D=async(e,l)=>{await p.assign(e,l)&&$(i.current).dxDataGrid("instance").refresh()};return t.createElement(t.Fragment,null,t.createElement(H,{gridRef:i,title:"Clientes",rest:p,toolBar:e=>{e.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"REFRESCAR TABLA",onClick:()=>$(i.current).dxDataGrid("instance").refresh()}})},filterValue:["status_id","=",12],columns:[n("projects","root","all","list")?{dataField:"id",caption:"ID",dataType:"number",cellTemplate:(e,{data:l,value:u,...d})=>{a(e,t.createElement(c,{className:"btn btn-xs btn-white",title:`Ver ${l.projects} proyectos`,onClick:()=>{d.component.collapseAll(-1),d.component.expandRow(d.row.data)}},t.createElement("i",{className:"fas fa-shapes"})," ",l.projects))},sortOrder:"desc"}:null,{dataField:"ruc",caption:"RUC"},{dataField:"tradename",caption:"Nombre comercial",width:250,cellTemplate:(e,{data:l})=>{a(e,t.createElement("div",{className:"d-flex align-items-center"},l.user_assigned.id&&t.createElement(Tippy,{content:`Atendido por ${l.user_assigned.name} ${l.user_assigned.lastname}`},t.createElement("img",{className:"avatar-xs rounded-circle me-1",src:`/api/profile/thumbnail/${l.user_assigned.relative_id}`,alt:l.user_assigned.name})),t.createElement("div",null,l.contact_name)))}},{dataField:"name",caption:"Razon social",visible:!1},{dataField:"contact_phone",caption:"Telefono"},{dataField:"contact_email",caption:"Correo"},{dataField:"status_id",caption:"ID estado cliente",dataType:"boolean",visible:!1},{dataField:"status",caption:"Estado",dataType:"boolean",cellTemplate:(e,{data:l})=>{switch(l.status){case 1:a(e,t.createElement("span",{className:"badge bg-success rounded-pill"},"Activo"));break;case 0:a(e,t.createElement("span",{className:"badge bg-danger rounded-pill"},"Inactivo"));break;default:a(e,t.createElement("span",{className:"badge bg-dark rounded-pill"},"Eliminado"));break}}},n("projects","root","all","list","update","changestatus","delete")?{caption:"Acciones",cellTemplate:(e,{data:l})=>{e.attr("style","display: flex; gap: 4px; overflow: visible"),n("projects","root","all","list")&&a(e,t.createElement(c,{className:"btn btn-xs btn-soft-dark",title:`Ver ${l.projects} proyectos en una nueva ventana`,onClick:()=>location.href=`/projects/?client=${l.name}`},t.createElement("i",{className:"mdi mdi-page-next"}))),n("clients","root","all","update")&&a(e,t.createElement(c,{className:"btn btn-xs btn-soft-primary",title:"Editar",onClick:()=>B(l)},t.createElement("i",{className:"fa fa-pen"}))),l.user_assigned.id?l.user_assigned.id==session.id&&a(e,t.createElement(c,{className:"btn btn-xs btn-soft-danger",title:"Dejar de atender",onClick:()=>D(l.id,!1)},t.createElement("i",{className:"fas fa-hands-wash"}))):a(e,t.createElement(c,{className:"btn btn-xs btn-soft-dark",title:"Atender lead",onClick:()=>D(l.id,!0)},t.createElement("i",{className:"fas fa-hands-helping"}))),n("leads","root","all","addnotes")&&a(e,t.createElement(c,{className:"btn btn-xs btn-soft-primary position-relative",title:"Ver/Agregar notas",onClick:()=>j(l)},t.createElement("i",{className:"fas fa-sticky-note"}),l.notes>0&&t.createElement("span",{className:"position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"},l.notes,t.createElement("span",{className:"visually-hidden"},"Notas de ",l.name)))),n("clients","root","all","changestatus")&&a(e,t.createElement(c,{className:"btn btn-xs btn-light",title:l.status===null?"Restaurar":"Cambiar estado",onClick:()=>q(l)},l.status===1?t.createElement("i",{className:"fa fa-toggle-on text-success"}):l.status===0?t.createElement("i",{className:"fa fa-toggle-off text-danger"}):t.createElement("i",{className:"fas fa-trash-restore"}))),n("clients","root","all","delete")&&a(e,t.createElement(c,{className:"btn btn-xs btn-soft-danger",title:"Eliminar",onClick:()=>O(l.id)},t.createElement("i",{className:"fa fa-trash-alt"})))},allowFiltering:!1,allowExporting:!1}:null],masterDetail:{enabled:!1,template:async(e,{data:l,component:u})=>{e.css("padding","10px"),e.css("overflow","visible");let{data:d}=await S.paginate({filter:["client_id","=",l.id],isLoadingAll:!0});const V=$('<div id="projects-grid" style="height: 320px">').appendTo(e).dxDataGrid({dataSource:d,onToolbarPreparing:r=>{r.toolbarOptions.items.unshift({widget:"dxButton",location:"after",options:{icon:"fa fa-times",hint:"CERRAR TABLA",onClick:f=>{u.collapseAll(-1)}}})},columns:[{dataField:"id",caption:"ID",dataType:"number",sortOrder:"asc"},{dataField:"type.name",caption:"Tipo"},{dataField:"name",caption:"Proyecto"},{dataField:"cost",caption:"Costo",dataType:"number",width:150,cellTemplate:(r,{data:o})=>{const f=(o.total_payments/o.cost*100).toFixed(2);a(r,t.createElement(t.Fragment,null,t.createElement("p",{className:"mb-1 d-flex justify-content-between"},t.createElement("span",null,"S/.",Number(o.total_payments).toFixed(2)),t.createElement("b",{className:"float-end"},"S/.",Number(o.cost).toFixed(2))),t.createElement("div",{className:"progress progress-bar-alt-primary progress-sm mt-0 mb-0"},t.createElement("div",{className:"progress-bar bg-primary progress-animated wow animated animated",role:"progressbar","aria-valuenow":o.total_payments,"aria-valuemin":"0","aria-valuemax":o.cost,style:{width:`${f}%`,visibility:"visible",animationName:"animationProgress"}}))))}},{dataField:"ends_at",caption:"Fecha de finalizaciÃ³n",dataType:"date",cellTemplate:(r,{data:o})=>{r.text(moment(o.ends_at).format("LL"))}},n("projects","root","all","changestatus")?{dataField:"project_status.name",caption:"Estado del proyecto",dataType:"string",cellTemplate:(r,{data:o})=>{r.attr("style","overflow: visible"),a(r,t.createElement(Y,{can:n,statuses:b,data:o,onChange:async()=>{const{data:f}=await S.paginate({filter:["client_id","=",l.id],isLoadingAll:!0});$("#projects-grid").dxDataGrid("instance").option("dataSource",f)}}))}}:null,{dataField:"status",caption:"Estado",dataType:"boolean",cellTemplate:(r,{data:o})=>{switch(o.status){case 1:a(r,t.createElement("span",{className:"badge bg-success rounded-pill"},"Activo"));break;case 0:a(r,t.createElement("span",{className:"badge bg-danger rounded-pill"},"Inactivo"));break;default:a(r,t.createElement("span",{className:"badge bg-dark rounded-pill"},"Eliminado"));break}}},{caption:"Acciones",cellTemplate:(r,{data:o})=>{r.attr("style","display: flex; gap: 4px; overflow: unset"),n("projects","root","all","addpayment")&&a(r,t.createElement(c,{className:"btn btn-xs btn-soft-success",title:"Ver/Agregar pagos",onClick:()=>k(o)},t.createElement("i",{className:"fas fa-money-check-alt"})))},allowFiltering:!1,allowExporting:!1}],allowColumnResizing:!0,columnResizingMode:"widget",columnAutoWidth:!0,showBorders:!0,columnChooser:{title:"Mostrar/Ocultar columnas",enabled:!0,mode:"select",search:{enabled:!0}}});M(V.dxDataGrid("instance"))}}}),t.createElement(J,{modalRef:g,title:L?"Editar cliente":"Agregar cliente",onSubmit:z,size:"md"},t.createElement("div",{className:"row"},t.createElement("input",{ref:E,type:"hidden"}),t.createElement(m,{eRef:R,label:"RUC",col:"col-4",required:!0}),t.createElement(m,{eRef:h,label:"Nombre comercial",col:"col-8",required:!0}),t.createElement(m,{eRef:v,label:"Razon social",col:"col-md-6",required:!0}),t.createElement(m,{eRef:y,label:"URL Web",col:"col-md-6"}),t.createElement(A,{eRef:N,label:"Mensaje",col:"col-12",required:!0}),t.createElement(A,{eRef:x,label:"Descripcion",col:"col-12"}),t.createElement("div",{className:"col-12"},t.createElement("hr",{className:"my-1"})),t.createElement(m,{eRef:w,label:"Nombre de contacto",col:"col-6"}),t.createElement(m,{eRef:C,label:"Celular de contacto",col:"col-6"}),t.createElement(m,{eRef:_,label:"Email de contacto",col:"col-12",type:"email"}),t.createElement(A,{eRef:T,label:"Direccion de contacto",col:"col-12"}))),t.createElement(X,{can:n,dataLoaded:G,setDataLoaded:k,grid2refresh:I}),t.createElement(K,{can:n,client:P,setClient:j,grid2refresh:i,page:"clients"}))};U((b,n)=>{if(!n.can("clients","root","all","list"))return location.href="/";W(b).render(t.createElement(Q,{...n,title:"Clientes"},t.createElement(Z,{...n})))});
